# 非機能要件

## 目次

- [概要](#概要)
- [パフォーマンス要件](#パフォーマンス要件)
  - [NFR-001: レスポンスタイム](#nfr-001-レスポンスタイム)
  - [NFR-002: スループット](#nfr-002-スループット)
  - [NFR-003: データベースパフォーマンス](#nfr-003-データベースパフォーマンス)
  - [NFR-004: キャッシュ戦略](#nfr-004-キャッシュ戦略)
- [スケーラビリティ要件](#スケーラビリティ要件)
  - [NFR-010: 水平スケーラビリティ](#nfr-010-水平スケーラビリティ)
  - [NFR-011: データ増加対応](#nfr-011-データ増加対応)
- [可用性・信頼性要件](#可用性信頼性要件)
  - [NFR-020: 稼働率](#nfr-020-稼働率)
  - [NFR-021: 障害復旧時間](#nfr-021-障害復旧時間)
  - [NFR-022: バックアップ](#nfr-022-バックアップ)
  - [NFR-023: フェイルオーバー](#nfr-023-フェイルオーバー)
- [セキュリティ要件](#セキュリティ要件)
  - [NFR-030: 認証・認可](#nfr-030-認証認可)
  - [NFR-031: データ保護](#nfr-031-データ保護)
  - [NFR-032: 脆弱性対策](#nfr-032-脆弱性対策)
  - [NFR-033: ログ・監査](#nfr-033-ログ監査)
- [ユーザビリティ要件](#ユーザビリティ要件)
  - [NFR-040: レスポンシブデザイン](#nfr-040-レスポンシブデザイン)
  - [NFR-041: ブラウザ対応](#nfr-041-ブラウザ対応)
  - [NFR-042: アクセシビリティ](#nfr-042-アクセシビリティ)
  - [NFR-043: 国際化・多言語対応](#nfr-043-国際化多言語対応)
- [保守性・運用性要件](#保守性運用性要件)
  - [NFR-050: 監視・通知](#nfr-050-監視通知)
  - [NFR-051: デプロイ](#nfr-051-デプロイ)
  - [NFR-052: ログ管理](#nfr-052-ログ管理)
  - [NFR-053: エラーハンドリング](#nfr-053-エラーハンドリング)
- [移植性・互換性要件](#移植性互換性要件)
  - [NFR-060: プラットフォーム独立性](#nfr-060-プラットフォーム独立性)
  - [NFR-061: 外部システム連携](#nfr-061-外部システム連携)
- [テスト容易性要件](#テスト容易性要件)
  - [NFR-070: テスタビリティ](#nfr-070-テスタビリティ)
- [コンプライアンス要件](#コンプライアンス要件)
  - [NFR-080: 法令遵守](#nfr-080-法令遵守)
  - [NFR-081: データ保持・削除](#nfr-081-データ保持削除)
- [ドキュメント要件](#ドキュメント要件)
  - [NFR-090: 技術ドキュメント](#nfr-090-技術ドキュメント)
  - [NFR-091: ユーザードキュメント](#nfr-091-ユーザードキュメント)
- [パフォーマンス目標の優先順位](#パフォーマンス目標の優先順位)
- [関連ドキュメント](#関連ドキュメント)

## 概要

このドキュメントでは、システムの品質特性に関する要件を定義します。
機能要件が「何をするか」を定義するのに対し、非機能要件は「どのように動作するか」を定義します。

---

## パフォーマンス要件

### NFR-001: レスポンスタイム
**優先度**: Must Have

**要件**:
| 操作 | 目標値 | 最大許容値 | 測定条件 |
|------|--------|-----------|----------|
| ページ表示（初回） | 1.5秒以内 | 3.0秒 | 社内WiFi、PC |
| ページ表示（2回目以降） | 0.5秒以内 | 1.0秒 | キャッシュ利用 |
| 検索結果表示 | 1.0秒以内 | 2.0秒 | 1000件ヒット時 |
| 資産詳細表示 | 0.8秒以内 | 1.5秒 | - |
| 貸出申請登録 | 0.5秒以内 | 1.0秒 | - |
| レポート生成 | 5.0秒以内 | 10.0秒 | 1000件データ |

**測定方法**:
- Chrome DevTools Lighthouse
- Google PageSpeed Insights
- New Relic等のAPMツール

---

### NFR-002: スループット
**優先度**: Must Have

**要件**:
| 指標 | 目標値 | ピーク時 |
|------|--------|----------|
| 同時接続ユーザー数 | 100人 | 300人 |
| リクエスト処理数 | 20 req/sec | 50 req/sec |
| API応答時間（95パーセンタイル） | 500ms以下 | 1,000ms以下 |

**負荷条件**:
- 通常時: 平日9-18時、20-50同時接続
- ピーク時: 棚卸し期間、期初・期末

---

### NFR-003: データベースパフォーマンス
**優先度**: Must Have

**要件**:
- クエリ実行時間: 平均100ms以内、最大500ms
- インデックス利用率: 95%以上
- スロークエリ: 1秒以上のクエリは全体の1%以下
- コネクションプール: 最大100接続、通常20-30接続維持

---

### NFR-004: キャッシュ戦略
**優先度**: Should Have

**要件**:
- 静的コンテンツ: CDNで配信、TTL 1週間
- 資産一覧: Redis等でキャッシュ、TTL 5分
- 資産詳細: キャッシュ、TTL 10分（貸出・返却時は即座に無効化）
- ユーザーセッション: Redis、TTL 1時間（自動延長）
- キャッシュヒット率: 70%以上

---

## スケーラビリティ要件

### NFR-010: 水平スケーラビリティ
**優先度**: Must Have

**要件**:
- アプリケーションサーバー: ステートレス設計、オートスケーリング対応
- データベース: リードレプリカ対応（最大3台まで）
- スケールアウト時間: 5分以内に新インスタンス起動
- 負荷分散: ロードバランサーによる自動振り分け

---

### NFR-011: データ増加対応
**優先度**: Should Have

**要件**:
| データ種別 | 初期想定 | 3年後想定 | 対応策 |
|-----------|---------|----------|--------|
| ユーザー数 | 500人 | 1,000人 | パーティショニング不要 |
| 資産数 | 4,000点 | 10,000点 | インデックス最適化 |
| 貸出履歴 | 月300件 | 月1,000件 | アーカイブ戦略 |
| 棚卸し履歴 | 年2回 | 年4回 | 履歴圧縮 |

---

## 可用性・信頼性要件

### NFR-020: 稼働率
**優先度**: Must Have

**要件**:
- サービス稼働率: 99.9%以上（年間ダウンタイム8.76時間以内）
- 計画メンテナンス: 月1回、深夜2-4時、2時間以内
- 緊急メンテナンス: 事前告知なしで実施可能だが年3回まで

**測定方法**:
- 外部監視サービス（Pingdom、UptimeRobot等）による監視
- 5分間隔でのヘルスチェック

---

### NFR-021: 障害復旧時間
**優先度**: Must Have

**要件**:
| 障害レベル | 目標復旧時間（RTO） | 目標データ損失（RPO） |
|-----------|---------------------|----------------------|
| レベル1（軽微） | 15分以内 | 0 |
| レベル2（重大） | 1時間以内 | 5分以内 |
| レベル3（致命的） | 4時間以内 | 1時間以内 |

**障害レベル定義**:
- レベル1: 一部機能の制限、サービス継続可能
- レベル2: 主要機能停止、購入不可
- レベル3: 全サービス停止

---

### NFR-022: バックアップ
**優先度**: Must Have

**要件**:
- データベースフルバックアップ: 毎日1回、深夜実施
- 差分バックアップ: 1時間ごと
- バックアップ保持期間: 30日間
- バックアップデータの暗号化: AES-256
- バックアップからの復旧テスト: 月1回実施

---

### NFR-023: フェイルオーバー
**優先度**: Should Have

**要件**:
- アプリケーションサーバー: 自動フェイルオーバー、切り替え時間1分以内
- データベース: マスター障害時、レプリカへ自動切り替え、5分以内
- キャッシュサーバー: 障害時は直接DBアクセス（性能劣化許容）

---

## セキュリティ要件

### NFR-030: 認証・認可
**優先度**: Must Have

**要件**:
- 社内SSO連携: Active DirectoryまたはGoogle Workspaceとの連携
- セッション管理: HTTPOnly Cookie、Secure属性、SameSite属性設定
- セッションID: 暗号学的に安全な乱数生成、推測不可能
- 多要素認証（MFA）: 管理者アカウントは必須、一般ユーザーはSSO経由で認証
- 権限管理: RBAC（ロールベースアクセス制御）による細かな権限設定
- セッションタイムアウト: 1時間（無操作時）

---

### NFR-031: データ保護
**優先度**: Must Have

**要件**:
- 通信の暗号化: TLS 1.2以上（推奨1.3）
- データベース暗号化: 保存データの透過的暗号化（TDE）
- 個人情報の暗号化: 社員情報（社員番号、氏名等）の適切な管理
- 機密資産情報の暗号化: 高額資産のシリアル番号等は暗号化
- ログの暗号化: 個人情報を含むログは暗号化

---

### NFR-032: 脆弱性対策
**優先度**: Must Have

**要件**:
| 脆弱性 | 対策 |
|--------|------|
| SQLインジェクション | プリペアドステートメント使用、ORMの適切な利用 |
| XSS（クロスサイトスクリプティング） | 入力値のサニタイズ、出力時のエスケープ、CSP設定 |
| CSRF | CSRFトークンの実装、SameSite Cookie属性 |
| セッションハイジャック | セッションID再生成、HTTPOnly/Secure Cookie |
| パストラバーサル | ファイルパスの検証、ホワイトリスト方式 |
| XXE | XML外部エンティティ無効化 |
| 認可不備 | 全API・画面で認可チェック、最小権限の原則 |

**検証方法**:
- OWASP ZAPによる自動スキャン（毎週実施）
- 定期的な脆弱性診断（年2回、外部専門業者）
- 依存ライブラリの脆弱性チェック（毎日、Dependabot等）

---

### NFR-033: ログ・監査
**優先度**: Must Have

**要件**:
- アクセスログ: 全HTTPリクエストを記録（IP、ユーザーID、エンドポイント、レスポンスコード）
- アプリケーションログ: エラー、警告、重要な業務操作を記録
- セキュリティログ: ログイン試行、パスワード変更、権限変更等を記録
- ログ保持期間: 1年間
- ログの改ざん防止: 追記専用、定期的な整合性チェック
- 監査証跡: 資産登録、貸出承認、返却処理、棚卸し、ユーザー情報変更等の重要操作を記録

---

## ユーザビリティ要件

### NFR-040: レスポンシブデザイン
**優先度**: Must Have

**要件**:
- 対応デバイス: スマートフォン、タブレット、PC
- ブレークポイント:
  - モバイル: 〜767px
  - タブレット: 768px〜1023px
  - デスクトップ: 1024px〜
- タッチ操作: ボタンサイズ44px×44px以上
- モバイルファースト設計

---

### NFR-041: ブラウザ対応
**優先度**: Must Have

**対応ブラウザ**:
| ブラウザ | 対応バージョン |
|---------|---------------|
| Chrome | 最新版 + 2バージョン前まで |
| Safari | 最新版 + 2バージョン前まで |
| Firefox | 最新版 + 2バージョン前まで |
| Edge | 最新版 + 2バージョン前まで |
| Safari iOS | 最新版 + 1バージョン前まで |
| Chrome Android | 最新版 + 1バージョン前まで |

※ Internet Explorer 11はサポート対象外

---

### NFR-042: アクセシビリティ
**優先度**: Should Have

**要件**:
- WCAG 2.1 レベルAA準拠
- キーボード操作: 全機能をキーボードのみで操作可能
- スクリーンリーダー対応: 適切なARIA属性、セマンティックHTML
- 色覚多様性対応: 色のみで情報を伝えない、コントラスト比4.5:1以上
- フォントサイズ: 最小14px、ブラウザ設定で拡大可能

---

### NFR-043: 国際化・多言語対応
**優先度**: Won't Have（将来対応）

**方針**:
- 文字コード: UTF-8
- タイムゾーン: JST（日本標準時）
- 日付形式: YYYY/MM/DD
- 通貨: 日本円（¥）
- 多言語化の準備: i18n対応の設計（今回は日本語のみ実装）

---

## 保守性・運用性要件

### NFR-050: 監視・通知
**優先度**: Must Have

**要件**:
| 監視項目 | 閾値 | 通知方法 |
|---------|------|---------|
| サーバーCPU使用率 | 80%超過5分継続 | Slack, Email |
| サーバーメモリ使用率 | 85%超過5分継続 | Slack, Email |
| ディスク使用率 | 80%超過 | Slack, Email |
| エラー率 | 5%超過 | Slack, Email, 電話 |
| レスポンスタイム | 3秒超過10%以上 | Slack |
| データベース接続数 | 90接続超過 | Slack |

**監視ツール**:
- インフラ監視: Datadog, CloudWatch等
- アプリケーション監視: New Relic, Sentry等
- 外形監視: Pingdom, UptimeRobot等

---

### NFR-051: デプロイ
**優先度**: Must Have

**要件**:
- デプロイ方式: Blue-Greenデプロイ、またはローリングデプロイ
- デプロイ頻度: 週1回以上可能
- デプロイ時間: 15分以内
- ロールバック: 問題発生時、5分以内に前バージョンへロールバック可能
- ゼロダウンタイムデプロイ: ユーザー影響なしでデプロイ実施

---

### NFR-052: ログ管理
**優先度**: Should Have

**要件**:
- ログ集約: 全サーバーのログを中央集約（ELKスタック、CloudWatch Logs等）
- ログ検索: 全文検索、フィルタリング、集計機能
- ログレベル: DEBUG, INFO, WARN, ERROR, FATAL
- 構造化ログ: JSON形式での出力
- ログローテーション: 1日1回、圧縮保存

---

### NFR-053: エラーハンドリング
**優先度**: Must Have

**要件**:
- ユーザーフレンドリーなエラーメッセージ表示
- 詳細なエラー情報は管理者のみ閲覧可能
- エラー発生時の自動通知（Slackやメール）
- エラーの分類（システムエラー、業務エラー、バリデーションエラー）
- リトライ機能: 外部API呼び出しは3回までリトライ（エクスポネンシャルバックオフ）

---

## 移植性・互換性要件

### NFR-060: プラットフォーム独立性
**優先度**: Should Have

**要件**:
- コンテナ化: Docker対応、環境依存を最小化
- インフラ: AWS、GCP、Azure等のクラウドプラットフォームに移行可能な設計
- データベース: 特定のDB固有機能に依存しない（ORMの適切な利用）
- OS: Linux（Ubuntu, Amazon Linux等）で動作

---

### NFR-061: 外部システム連携
**優先度**: Must Have

**要件**:
| 連携先 | プロトコル | 可用性要件 |
|--------|-----------|-----------|
| 社内認証システム（AD/Google Workspace） | OAuth 2.0 / SAML 2.0 | 99.9%以上 |
| メール配信サービス | SMTP/API | 障害時はキュー蓄積、再送 |
| 会計システム（勘定奉行） | CSV/Excel連携 | 非同期連携、手動対応可 |

**連携の考慮事項**:
- タイムアウト設定: 10秒
- リトライ: 3回まで
- サーキットブレーカー: 連続5回失敗でサービス一時停止、1分後に再試行

---

## テスト容易性要件

### NFR-070: テスタビリティ
**優先度**: Should Have

**要件**:
- 単体テストカバレッジ: 80%以上
- E2Eテストカバレッジ: 主要シナリオ90%以上
- テストデータ生成: ファクトリ、フィクスチャの整備
- モック・スタブ: 外部依存のモック化可能な設計
- テスト環境: 本番と同等の環境を用意

---

## コンプライアンス要件

### NFR-080: 法令遵守
**優先度**: Must Have

**対象法令**:
- 個人情報保護法
- 固定資産管理規程（社内規定）
- 情報セキュリティポリシー（社内規定）

**要件**:
- 個人情報の利用目的明示
- プライバシーポリシーの掲示
- 固定資産管理規程に準拠した資産情報管理
- 情報セキュリティポリシーに準拠したアクセス制御

---

### NFR-081: データ保持・削除
**優先度**: Must Have

**要件**:
- 個人情報の保持期間: サービス利用終了後3年間
- ユーザーからの削除要求: 30日以内に対応
- 右to忘れられる権利: ユーザーが自身のデータ削除を要求可能
- データ匿名化: 統計分析用には個人を特定できない形式に加工

---

## ドキュメント要件

### NFR-090: 技術ドキュメント
**優先度**: Should Have

**要件**:
- アーキテクチャドキュメント
- API仕様書（OpenAPI形式）
- データベーススキーマ設計書
- インフラ構成図
- デプロイ手順書
- 障害対応手順書（ランブック）

---

### NFR-091: ユーザードキュメント
**優先度**: Must Have

**要件**:
- ヘルプページ
- FAQ
- 利用規約
- プライバシーポリシー
- 資産管理ガイドライン

---

## パフォーマンス目標の優先順位

| カテゴリ | 優先度 | 理由 |
|---------|-------|------|
| セキュリティ | 最高 | 法令遵守、信頼性の基盤 |
| 可用性 | 高 | ビジネス継続性の要 |
| パフォーマンス | 高 | ユーザー体験に直結 |
| スケーラビリティ | 中 | 成長対応、初期は過剰投資不要 |
| 保守性 | 中 | 長期運用での重要性 |
| アクセシビリティ | 中 | 顧客層拡大、社会的責任 |
| 移植性 | 低 | 初期は単一環境で可 |

---

## 関連ドキュメント

- [機能要件](functional-requirements.md) - 本非機能要件が適用される機能
- [制約事項](constraints.md) - 非機能要件に影響する制約
- [../02-architecture/](../02-architecture/) - 非機能要件を満たすアーキテクチャ設計
- [../05-tests/](../05-tests/) - 非機能要件を検証するテスト仕様

